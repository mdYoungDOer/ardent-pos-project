# Enable required modules
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so

# Set document root
DocumentRoot /var/www/html/public

# Configure directory
<Directory /var/www/html/public>
    AllowOverride All
    Require all granted
    
    # Enable rewrite engine
    RewriteEngine On
    
    # Handle PHP files first (including debug endpoints)
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_FILENAME} \.php$
    RewriteRule ^(.*)$ $1 [L]
    
    # Handle API requests
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^api/(.*)$ api/index.php [QSA,L]
    
    # Handle frontend routes (SPA) - only for non-PHP files
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !\.php$
    RewriteRule ^(.*)$ index.html [QSA,L]
</Directory>

# API-specific configuration
<LocationMatch "^/api/">
    # Remove CORS headers from Apache since they're handled by PHP middleware
    # This prevents header duplication
    
    # Set proper content types for API responses
    Header set Content-Type "application/json"
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
</LocationMatch>

# PHP files configuration
<LocationMatch "\.php$">
    # Security headers for PHP files
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
</LocationMatch>

# Static assets configuration
<Directory /var/www/html/public/assets>
    # Set proper MIME types for JavaScript files
    <FilesMatch "\.js$">
        Header set Content-Type "application/javascript"
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    # Set proper MIME types for CSS files
    <FilesMatch "\.css$">
        Header set Content-Type "text/css"
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    # Set proper MIME types for other assets
    <FilesMatch "\.(json|svg|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
</Directory>

# Security configuration
ServerTokens Prod
ServerSignature Off

# Performance configuration
EnableSendfile On
EnableMMAP On
